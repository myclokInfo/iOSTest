version: 2
jobs:
  build:
    docker:
    - image: circleci/ruby:2.5.1-node-browsers
    - image: circleci/postgres:9.6.2-alpine
      environment:
      - POSTGRES_USER: root
      - POSTGRES_DB: circle-test_test
    macos:
      xcode: 10.0.0
    working_directory: ~/project/myclok
    shell: /bin/bash --login -o pipefail
    environment:
    - FL_OUTPUT_DIR: output
    steps:
    - add-ssh-keys:
        fingerprints:
        - f4:7a:11:ad:1a:0f:13:9b:f6:57:3b:7e:74:3b:82:1a
    - run:
        name: Set Ruby version
        command: echo "ruby-2.5.1" > ~/.ruby-version
    - run:
        name: Clone Test Web Repo
        command: |
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git clone git@github.com:myclokInfo/TestRubyRepo.git
    - run:
        name: Install Freshly Repo & Boot rails server
        command: |
          cd TestRubyRepo
          git checkout develop
          gem install bundler && bundle install
          rails server
        background: true
    - checkout
    - run:
        name: Run unit tests
        command: |
          if [ "${CIRCLE_BRANCH}" == "MOB-1515/smoke-test" ]; then
            bash .circleci/smoke-tests.sh
          fi

          if [ "${CIRCLE_BRANCH}" != "MOB-1515/smoke-test" ]; then
             bash .circleci/run-tests.sh
          fi
    - store_test_results:
        path: output/scan
    - store_artifacts:
        path: output
workflows:
  version: 2
  build-and-test:
    jobs:
    - build